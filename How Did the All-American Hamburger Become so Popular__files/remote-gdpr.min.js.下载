!function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=169)}({1:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n=window,o=!1;"_gdprDebug"in n&&(o=n._gdprDebug);let s={isDebug:()=>o,logPrefix:"[GDPR2]",log(...e){if(s.isDebug()){let t=[s.logPrefix].concat(e);console.debug(...t)}}};t.default=s},102:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(103),s=r(53),i=n(r(1)),a=r(46);t.RemoteServiceProxy=class{constructor(e){this.wrapped=e;let t=this,r={getSession:e=>t.wrapped.getSession(e),persistSession:(e,r)=>t.wrapped.persistSession(e,r),deleteSession:()=>t.wrapped.deleteSession(),rmiReady:()=>t.wrapped.rmiReady(),hasInternalStorage:()=>t.wrapped.hasInternalStorage()};this.proxy=new a.PostMessageProxyPromise(r).setPairedParty(window.parent),this.proxy.invoke("remoteIsReady").then(e=>i.default.log("Client answered to remoteIsReady"))}};t.ServiceController=class{constructor(e,t,r){this.config=e,this.storage=new o.GDPRLocalStorageImpl(e.storage);let n=this;this.opts=t,this.api=r(e.domain.fullHostname,!0,e=>{i.default.log("There was an error in ConsentAPI invocation",e),400==e.status||401==e.status||403==e.status||404==e.status?(i.default.log("error is eligible for usertoken invalidation"),n.storage.removeAccessToken(),n.api.updateToken(null)):i.default.log("Error is not eligible for action")});let s=this.storage.getAccessToken();s&&this.api.updateToken(s)}hasInternalStorage(){return Promise.resolve({success:this.storage.isStorageAvailable()})}getSession(){let e=this;if(this.storage.isStorageAvailable()){let t=e.storage.getUCString(),r=e.storage.getTCString(),n=e.storage.getWrappedACString();if(t&&r)return i.default.log("Session Data Retrieved from Storage"),Promise.resolve({session:{ucstring:t,tcstring:r,acstring:n},success:!0})}return e.api.hasToken()?(i.default.log("Trying to retrieve session from remote"),new Promise((t,r)=>{e.api.getConsent().then(r=>{i.default.log("Retrieved session from remote"),e.storage.setTCString(r.iabconsent),e.storage.setUCString(r.fpconsent),t({session:{ucstring:r.fpconsent,tcstring:r.iabconsent},success:!0})}).catch(e=>{i.default.log("error retrieving remote session",e),t({session:{},success:!0})})})):Promise.resolve({session:{},success:!0})}persistSession(e){let t=this;if(e.tcstring&&e.ucstring){let r={success:t.storage.setTCString(e.tcstring)&&t.storage.setUCString(e.ucstring)&&t.storage.setWrappedACString(e.acstring)};i.default.log("Proceeding with async remote persist");let n=t.api.setConsent(e.ucstring,t.config.domain.contextName,e.tcstring,e.acstring).then(e=>(i.default.log("async save completed correctly",e,t.api.getToken()),s.instOfCreationResponse(e)?e.token!=t.api.getToken()&&(i.default.log("Updating token"),t.storage.setAccessToken(e.token),t.api.updateToken(e.token)):i.default.log("It's an update nothing to store in token"),r)).catch(e=>(i.default.log("There was an error pesisting remotely",e),r));if(t.opts&&t.opts.remoteSync){const e=t.opts.timeout&&t.opts.timeout>=100?t.opts.timeout:1e3;return i.default.log("Using remote sync promise on storage with timeout",e),n}return Promise.resolve(r)}return Promise.reject("Empty data nothing to save")}deleteSession(){return i.default.log("Removing all consent data"),this.storage.removeAccessToken(),this.storage.removeTCString(),this.storage.removeUCString(),this.storage.removeWrappedACString(),Promise.resolve({success:!0})}rmiReady(){return Promise.resolve({success:!0})}}},103:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(r(1));t.GDPRLocalStorageImpl=class{constructor(e){this.settings=e}isStorageAvailable(){let e=!1;try{window.localStorage.setItem("check_item","a"),window.localStorage.getItem("check_item"),window.localStorage.removeItem("check_item"),e=!0}catch(e){o.default.log("LocalStorage is unavailable",e)}return e}tryGet(e){let t=null;try{t=window.localStorage.getItem(e(this.settings.names))}catch(e){o.default.log("Could not retrieve value from localStorage",e)}return t&&""!==t?t:null}trySet(e,t){let r=!1;try{window.localStorage.setItem(e(this.settings.names),t),r=!0}catch(e){o.default.log("An error occurred while saving to localStorage",e)}return r}tryRemove(e){let t=!1;try{window.localStorage.removeItem(e(this.settings.names)),t=!0}catch(e){o.default.log("An error occurred while removing from localstorage",e)}return t}getAccessToken(){return this.tryGet(e=>e.user_token)}setAccessToken(e){return this.trySet(e=>e.user_token,e)}removeAccessToken(){return this.tryRemove(e=>e.user_token)}getSettings(){return this.settings}getTCString(){return this.tryGet(e=>e.iab_settings)}setTCString(e){return this.trySet(e=>e.iab_settings,e)}removeTCString(){return this.tryRemove(e=>e.iab_settings)}getUCString(){return this.tryGet(e=>e.fanpage_settings)}setUCString(e){return this.trySet(e=>e.fanpage_settings,e)}removeUCString(){return this.tryRemove(e=>e.fanpage_settings)}getWrappedACString(){return this.tryGet(e=>e.ac_settings)}setWrappedACString(e){return this.trySet(e=>e.ac_settings,e)}removeWrappedACString(){return this.tryRemove(e=>e.ac_settings)}}},104:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(105),s=n(r(1)),i=r(53);t.ConsentApiClientV1=class{constructor(e,t,r){this.host=e,this.secure=t,this.requestor=new o.ReqHelper(e,t,r),this.gdpr_token=null}getConsent(e){const t=e&&e>=200?e:2e3;return s.default.log("Using Timeout for get consent",t),this.gdpr_token?new Promise((e,r)=>{this.requestor.get("/consent",null,t).then(t=>{i.instOfConsentResponse(t.data)?e(t.data):(s.default.log("invalid response format",t.data),r(new Error("Invalid response format")))}).catch(e=>r(e))}):Promise.reject(new Error("This call must be authenticated"))}setConsent(e,t,r,n,o){s.default.log("Using Timeout for set consent",o||"no-timeout");let a={};return a.fpconsent=e,a.domain=t,r&&(a.iabconsent=r),n&&(a.acstring=n),new Promise((e,t)=>{this.requestor.post("/consent",null,a,o).then(r=>{i.instOfCreationResponse(r.data)||i.instOfConsentResponse(r.data)?e(r.data):t(new Error("Invalid response format"))}).catch(e=>t(e))})}updateToken(e){this.gdpr_token=e,this.requestor.withToken(e)}hasToken(){return this.gdpr_token&&""!==this.gdpr_token}getToken(){return this.gdpr_token}}},105:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(54),s=n(r(106));t.ReqHelper=class{constructor(e,t,r,n){this.host=e,this.secure=t,this.basePath="",this.onError=r,this.onSuccess=n}buildUrl(e){return"http"+(this.secure?"s":"")+"://"+this.host+this.basePath+e}withToken(e){return this.gdpr_token=e,this}withPath(e){return this.basePath=e,this}withErrorCallback(e){return this.onError=e,this}withOkCallback(e){return this.onSuccess=e,this}doReq(e,t,r,n,o){let i=this;return new Promise((a,u)=>{let l=s.default.getAjaxRequestObject((function(e,t,r){i.onSuccess&&i.onSuccess(e),a({error:null,data:e,status:200})}),(function(e,t){let r;"number"==typeof t?r=t:(r=parseInt(t),isNaN(r)&&(r=0));let n={status:r,msg:e+"",code:r};i.onError&&i.onError(n),a({error:n,data:null,status:r})})),c=r||{};i.gdpr_token&&(l.headers={},l.headers["X-GDPR-Auth"]=i.gdpr_token),o&&(l.timeout=o),l.url=s.default.forgeEndpoint(i.buildUrl(t),c),l.method=e,l.data=n,s.default.ajax(l)})}get(e,t,r){return this.doReq(o.ReqHTTPMethod.GET,e,t,null,r)}put(e,t,r,n){return this.doReq(o.ReqHTTPMethod.PUT,e,t,r,n)}post(e,t,r,n){return this.doReq(o.ReqHTTPMethod.POST,e,t,r,n)}delete(e,t,r,n){return this.doReq(o.ReqHTTPMethod.DELETE,e,t,r,n)}head(e,t,r,n){return this.doReq(o.ReqHTTPMethod.HEAD,e,t,r,n)}}},106:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(54),s=n(r(1));let i={forgeEndpoint(e,t){s.default.log("params",e,t);let r=[];for(let e in t){let n=t[e];r.push(encodeURIComponent(e)+"="+encodeURIComponent(n))}return e+"?"+r.join("&")},getAjaxRequestObject(e,t){let r={method:o.ReqHTTPMethod.GET,url:null,processData:!0,data:null,contentType:"application/json",dataType:"json",async:!0,timeout:-1,headers:null,success:null,error:null};return r.success=e,r.error=function(e,r,n){let o;if(t)if(e.responseText&&e.responseText.length>0){s.default.log("Parsing JSON error string: "+e.responseText);try{o=JSON.parse(e.responseText)}catch(e){o=e}null!=(null!=o?o.message:void 0)?t(o.message,r):(s.default.log("Error body not JSON. This could be strange"),t(e.responseText,r))}else s.default.log("Empty error body. This could be strange"),t(r,r)},r},ajax(e){if(e&&e.url){let r;if(window.XMLHttpRequest)try{r=new XMLHttpRequest}catch(e){r=new ActiveXObject("Microsoft.XMLHTTP")}else r=new ActiveXObject("Microsoft.XMLHTTP");if(r){let n,s,i=e.method!=o.ReqHTTPMethod.GET&&e.method!=o.ReqHTTPMethod.HEAD,a=(t=e.method)==o.ReqHTTPMethod.GET?"GET":t==o.ReqHTTPMethod.POST?"POST":t==o.ReqHTTPMethod.PUT?"PUT":t==o.ReqHTTPMethod.DELETE?"DELETE":t==o.ReqHTTPMethod.HEAD?"HEAD":"GET";if(e.dataType&&("html"==e.dataType||"xml"==e.dataType?(n=function(e){return e.responseXML},s="html"==e.dataType?"text/html":"text/xml"):"json"==e.dataType&&(n=function(e){var t;try{t=JSON.parse(e.responseText)}catch(e){console.warn("error parsing response",e)}return t})),n||(n=function(e){return e.responseText}),r.onreadystatechange=function(){r.readyState==XMLHttpRequest.DONE&&(200==r.status?e.success(n(r),200,r):e.error(r,r.status,r.responseText))},r.open(a,e.url,!!e.async),s&&r.overrideMimeType(s),e.timeout&&e.timeout>0&&(r.timeout=e.timeout),e.contentType&&r.setRequestHeader("Content-Type",e.contentType),e.headers)for(let t in e.headers)r.setRequestHeader(t,e.headers[t]);i&&e.data?"string"==typeof e.data?r.send(e.data):r.send(JSON.stringify(e.data)):r.send()}else e.error(null,600,"Missing XMLHttpRequest")}else console.warn("RequestObject is not a valid object",e,e?e.url:"nourl");var t}};t.default=i},141:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const n=r(142);t.default=function(e,t,r){return new n.ConsentApiClientV2(e,t,r)}},142:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(r(1)),s=r(53),i=r(104);class a extends i.ConsentApiClientV1{constructor(e,t,r){super(e,t,r)}getConsent(e){const t=e&&e>=200?e:2e3;return o.default.log("Using Timeout for get consent",t),this.gdpr_token?new Promise((e,r)=>{this.requestor.post("/consent/get",null,t).then(t=>{s.instOfConsentResponse(t.data)?e(t.data):(o.default.log("invalid response format",t.data),r(new Error("Invalid response format")))}).catch(e=>r(e))}):Promise.reject(new Error("This call must be authenticated"))}}t.ConsentApiClientV2=a},143:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(102),s=n(r(141)),i=r(48),a=n(r(1));t.default=function(e="1.2.0",t,r="cmpv2"){console.log("[GDPR2] RMI running version "+e);let n=r;"_gdprOverrideSubdomain"in t&&t._gdprOverrideSubdomain.length>0&&(n=t._gdprOverrideSubdomain);let u=i.ConfigBuilderV1(document.location.hostname,e,n,!0);a.default.logPrefix="[GDPR2-RMI]";let l=new o.ServiceController(u,null,s.default);return new o.RemoteServiceProxy(l)}},169:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0}),n(r(143)).default("1.2.5",window)},46:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=n(r(1)),s=n(r(47));t.PostMessageProxyPromise=class{constructor(e,t=window,r,n,o="*"){this.me=t,this.service=e,this.pairedParty=r,this.targetOrigin=o,this.promiseMap={};let s=this;function i(e){s.dispatchMsg(e)}this.filterFunc=n||function(e,t){return t==this.pairedParty},t.addEventListener?t.addEventListener("message",i,!1):"attachEvent"in t&&t.attachEvent("message",i)}setPairedParty(e){return this.pairedParty=e,this}internalSend(e){if(this.pairedParty){let t=JSON.stringify(e);this.pairedParty.postMessage(t,this.targetOrigin)}else o.default.log("No paired party set could not send message")}dispatchMsg(e){if(this.filterFunc(e.origin,e.source)){let r=e.data;try{r=JSON.parse(r)}catch(e){}if((t=r).method&&""!==t.method){let e=r.method;if(o.default.log("dispatching",r),e in this.service){let t=this,n=this.service[e](...r.args);r.callbackId&&n.then(e=>{let n={callbackMethodId:r.callbackId,data:e};t.internalSend(n)}).catch(e=>{let n={callbackMethodId:r.callbackId,err:e};t.internalSend(n)})}else o.default.log("Missing service definition for name:",r.method,r)}else if(function(e){return""!=e.callbackMethodId}(r))if(r.callbackMethodId in this.promiseMap){let e=this.promiseMap[r.callbackMethodId];r.err?e.err(r.err):e.solve(r.data),delete this.promiseMap[r.callbackMethodId]}else o.default.log("Could not find an entry for callbackId:",r.callbackMethodId);else o.default.log("Malformed message from paired party",e.data)}var t}invoke(e,...t){let r={method:e,args:t.filter(e=>!(e instanceof Function))},n=this;return r.callbackId=s.default(),new Promise((e,t)=>{n.promiseMap[r.callbackId]={solve:e,err:t},n.internalSend(r)})}}},47:function(e,t,r){"use strict";function n(){return Math.floor(65536*Math.random()).toString(16)}Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(){return n()+n()+"-"+n()+"-"+n()+"-"+n()+"-"+n()+n()+n()}},48:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});const o=r(49),s=r(50),i=n(r(51));function a(e){return 86400*e}function u(e){return a(31)*e}function l(e){return a(365)*e}t.ConfigBuilderV1=function(e,t,r="cmp",n=!1){let a=s.getSecondLevelDomain(e),c=`${r}.${a}`,d=/(http(?:s)?:\/\/)?(\w+\.)?((fanpage|ciaopeople|ohga)\.(it|com|run)|((\w+\.)?ciaopeople\.mgr\.consensu\.org)|(cookist|pandoski|kodami)\.(com|run|it))/,g=s.isDevEnvironment(e),f=g?c:`static-${r}.ciaopeople.it`,h=s.getContextFromDomainName(e),p=i.default(h);return{sdk:{version:t},storage:{durationInSeconds:u(1),extendedDuration:l(1),tokenDuration:l(1),iabDuration:l(1)+u(1),names:{fanpage_settings:"fpconsent",iab_settings:"euconsent",user_token:"gdprtoken",ac_settings:"wrapac"},mode:o.StorageMode.LOCALSTORAGE,options:{}},rmi:{publishOrigin:"https://"+c,allowedOrigins:e=>!!e.match(d),remote:`${t}/rmi/remote-gdpr${g?"":".min"}.js`,embedBase:`https://${c}/embed2/rmi`,acHost:f,gvlOrigin:"https://"+f},domain:{fullHostname:e,secondLevelDomain:a,contextName:h},stats:{generalEnable:!0,analytics:p}}}},49:function(e,t,r){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.COOKIES=1]="COOKIES",e[e.LOCALSTORAGE=2]="LOCALSTORAGE"}(n||(n={})),t.StorageMode=n},50:function(e,t,r){"use strict";function n(e){var t=e.split(".");if(t&&t.length>=2)return t[t.length-2].toLowerCase();throw"Could not get domain"}function o(e){var t=e.split(".");if(t&&t.length>=2)return t[t.length-1].toLowerCase();throw"Could not get TLD"}Object.defineProperty(t,"__esModule",{value:!0}),t.getSecondLevelDomain=function(e){var t=e.split(".");if(t&&t.length>=2)return t[t.length-2]+"."+t[t.length-1];throw"Could not get domain"},t.getNameWithoutDomain=n,t.getContextFromDomainName=function(e){var t=n(e),r=o(e);return"cookist"==t||"kodami"==t?t+"_"+r:t},t.isDevEnvironment=function(e){let t=o(e);return t&&"run"===t}},51:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});let n={fanpage:{accountId:"UA-18802610-1"},ohga:{accountId:"UA-18802610-54"},cookist_com:{accountId:"UA-18802610-50"},cookist_it:{accountId:"UA-18802610-47"},kodami_it:{accountId:"UA-18802610-53"}};t.default=function(e){return e in n?n[e]:n.fanpage}},53:function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.instOfCreationResponse=function(e){return e.iabconsent&&e.fpconsent&&e.token},t.instOfConsentResponse=function(e){return e.iabconsent&&e.fpconsent}},54:function(e,t,r){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e[e.GET=1]="GET",e[e.PUT=2]="PUT",e[e.POST=3]="POST",e[e.HEAD=4]="HEAD",e[e.DELETE=5]="DELETE"}(n||(n={})),t.ReqHTTPMethod=n}});
//# sourceMappingURL=remote-gdpr.min.js.map